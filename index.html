<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>High-Fidelity 3D Village Experience</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; }
    canvas { display: block; width: 100vw; height: 100vh; }
    #info {
      position: absolute; top: 10px; left: 10px;
      color: #fff; font-family: sans-serif;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px; border-radius: 4px;
      z-index: 100;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js"
    }
  }
  </script>
</head>
<body>
  <div id="info">TAB: 中⇔外 | WASD or ←→↑↓: 移動 | ↑↓: カメラ高さ</div>
  <canvas id="scene"></canvas>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/RGBELoader.js';
    import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/postprocessing/UnrealBloomPass.js';
    import { SSAOPass } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/postprocessing/SSAOPass.js';

    const canvas = document.getElementById('scene');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const scene = new THREE.Scene();

    // HDR sky
    new RGBELoader()
      .setDataType(THREE.UnsignedByteType)
      .load('https://rawcdn.githack.com/mrdoob/three.js/dev/examples/textures/equirectangular/venice_sunset_1k.hdr', env => {
        env.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = env;
        scene.background = env;
      });

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
    camera.position.set(0, 2, 6);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0,1,0);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
    scene.add(hemi);
    const sun = new THREE.DirectionalLight(0xfff8e5, 1.2);
    sun.position.set(10, 20, 10);
    sun.castShadow = true;
    sun.shadow.camera.near = 1;
    sun.shadow.camera.far = 100;
    sun.shadow.mapSize.set(2048,2048);
    scene.add(sun);

    // Ground with PBR textures
    const texLoader = new THREE.TextureLoader();
    const groundColor = texLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
    const groundNorm = texLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big-nm.jpg');
    [groundColor, groundNorm].forEach(t => { t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(50,50); });
    const groundMat = new THREE.MeshStandardMaterial({ map: groundColor, normalMap: groundNorm, roughness: 0.8 });
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Load high-detail village model
    const loader = new GLTFLoader();
    loader.load('https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/AnimatedMorphSphere/glTF/AnimatedMorphSphere.gltf', gltf => {
      const village = gltf.scene;
      village.traverse(o=>o.isMesh && (o.castShadow = o.receiveShadow = true));
      village.scale.set(3,3,3);
      village.position.set(0, 0, -10);
      scene.add(village);
    });

    // Rustic house interior
    const houseLoader = new GLTFLoader();
    houseLoader.load('https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoxHouse/glTF/BoxHouse.gltf', gltf => {
      const h = gltf.scene;
      h.traverse(o=>o.isMesh && (o.castShadow = o.receiveShadow = true));
      h.scale.set(1.5,1.5,1.5);
      h.position.set(-5,0,-5);
      scene.add(h);
    });

    // Trees instanced
    const trunkGeo = new THREE.CylinderGeometry(0.3,0.3,4,12);
    const leafGeo = new THREE.ConeGeometry(1.5,4,8);
    const instTrunks = new THREE.InstancedMesh(trunkGeo, new THREE.MeshStandardMaterial({color:0x8b5a2b}), 50);
    const instLeaves = new THREE.InstancedMesh(leafGeo, new THREE.MeshStandardMaterial({color:0x228b22}), 50);
    for(let i=0;i<50;i++){
      const x=(Math.random()-0.5)*100, z=(Math.random()-0.5)*100;
      const mTr = new THREE.Matrix4().makeTranslation(x,2,z);
      const mLf = new THREE.Matrix4().makeTranslation(x,4.5,z);
      instTrunks.setMatrixAt(i,mTr);
      instLeaves.setMatrixAt(i,mLf);
    }
    instTrunks.castShadow = true; scene.add(instTrunks);
    instLeaves.castShadow = true; scene.add(instLeaves);

    // NPCs: animated GLTF (CesiumMan)
    const npcLoader = new GLTFLoader();
    const mixers = [];
    npcLoader.load('https://rawcdn.githack.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMan/glTF/CesiumMan.gltf', gltf => {
      for(let i=0;i<5;i++){
        const npc = gltf.scene.clone();
        npc.position.set((Math.random()-0.5)*50,0,(Math.random()-0.5)*50);
        npc.scale.set(1,1,1);
        scene.add(npc);
        const mixer = new THREE.AnimationMixer(npc);
        mixer.clipAction(gltf.animations[0]).play();
        mixers.push(mixer);
      }
    });

    // Post-processing
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new SSAOPass(scene, camera, window.innerWidth, window.innerHeight));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.5, 0.4, 0.85));

    // Resize
    window.addEventListener('resize', () => {
      const w=window.innerWidth, h=window.innerHeight;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w,h); composer.setSize(w,h);
    });

    // Animate
    const clock = new THREE.Clock();
    function animate(){
      const dt = clock.getDelta();
      mixers.forEach(m => m.update(dt));
      controls.update();
      composer.render();
      requestAnimationFrame(animate);
    }
    animate();
  </script>
</body>
</html>
